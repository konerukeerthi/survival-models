---
title: "supplement 7"
author: "Steve Simon"
date: "June 2, 2018"
output: html_document
---

This file creates various formulas and graphs needed to illustrate the underlying theory behind the data analyses in survival-lecture-7.Rmd. I am sharing this for those who are curious, but you are not responsible for learning or using the code shown in this supplement.

```{r render, eval=FALSE, echo=FALSE}
# run the commands in this section to store the output
# in the results folder.
library(rmarkdown)
f <- "~/survival-models/src/supplement-7.Rmd"
o <- "~/survival-models/results"
render(f, output_dir=o)
```

This file does not need any special libraries other than the ones listed below. Many of the data sets in this program use data from Hosmer, Lemeshow, and May.

```{r load-libraries}
library(broom)
library(dplyr)
library(ggplot2)
library(magrittr)
library(survival)
library(tidyr)
```

## Interval censored data

An event is said to be interval censored in the interval (a,b) if you know that the event did not occur before time a and that it did occur before time b.

A right censored observation is equivalent to interval censoring on the interval (a, $\infty$).

A left censored observation is equivalent to interval censoring on the interval (0, b).

The likelihood in most settings is the product of the density functions, but with interval censoring, you replace the density by

$\int_a^b f(t; \beta) = S(a; \beta)-S(b; \beta)$

## Left truncation

In most studies, patients are considered part of the risk set from time 0 to the time that they either die or are censored. But sometimes patients start contributing information about survival only from a certain point forward. This is left truncation.

Here's an example from

math.usu.edu/jrstevens/biostat/projects2013/pres_LeftTruncation.pdf

```{r psychiatric, fig.width=4.5, fig.height=2.5}
par(mar=c(2.6, 2.6, 0.6, 0.6), las=1)
fn <- "~/survival-models/bin/psychiatric.RData"
load(fn)
head(psychiatric)
psychiatric %<>% arrange(age, age2)
n <- dim(psychiatric)[1]
n_atrisk <- rep(NA, 80)
for (i in 1:80) {
  n_atrisk[i] <- sum((psychiatric$age<=i) - (psychiatric$age2<=i))
}
plot(c(0, 80), c(1,n), type="n")
segments(psychiatric$age, 1:n, psychiatric$age2, 1:n)
plot(1:80, n_atrisk, type="s", ylim=c(0,25))
psychiatric              %$%
  Surv(age, age2, death=="death") -> psychiatric_surv
survfit(psychiatric_surv~psychiatric$sex)    %>%
  tidy                                       -> psychiatric_km
m <- psychiatric_km$strata=="psychiatric$sex=male"
f <- psychiatric_km$strata=="psychiatric$sex=female"
plot(c(0, 80), c(0, 1), type="n")
lines(
  psychiatric_km$time[f],
  psychiatric_km$estimate[f], 
  type="s")
lines(
  psychiatric_km$time[m], 
  psychiatric_km$estimate[m], 
  type="s", col="red")
```

The asaur package has all the data sets using in the book Applied Survival Analysis Using R, by Dirk F. Moore.

```{r ashkenazi}
library(asaur)
head(ashkenazi)
table(table(ashkenazi$famID))
table(ashkenazi$brcancer)
table(ashkenazi$mutant)
summary(ashkenazi$age)
bc_surv <- Surv(ashkenazi$age, ashkenazi$brcancer)
bc_km <- survfit(bc_surv~ashkenazi$mutant)
plot(bc_km)
```

```{r}
library(timereg)
data(diabetes)
head(diabetes)
table(table(diabetes$id))
summary(diabetes$time)
table(diabetes$status)
table(diabetes$trteye)
table(diabetes$treat)
table(diabetes$adult)
summary(diabetes$agedx)
```

The kidney data set contains information on catheter infections, and is available within the survival package of R.

```{r kidney}
head(kidney)
table(table(kidney$id))
table(kidney$status)
table(kidney$sex)
table(kidney$disease)
summary(kidney$time)
summary(kidney$age)
summary(kidney$frail)

Save everything for possible later re-use.

```{r save-everything}
save.image("~/survival-models/bin/supplement-7.RData")
```