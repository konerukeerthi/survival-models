---
title: "survival lecture 7"
author: "Steve Simon"
date: "April 8, 2018"
output: html_document
---

Lecture 7. Time varying covariates in a Cox model. Time varying covariates allow you to account for non-proportional hazards and can model settings where patients switch from one therapy to another. You will code data for time-varying covariates, fit time-varying models, and interpret the results.

This file does not need any special libraries other than the ones listed below. Many of the data sets in this program use data from Hosmer, Lemeshow, and May. I made one minor change, however, which was to force all the variable names to lower case.

```{r load-libraries}
library(broom)
library(dplyr)
library(ggplot2)
library(magrittr)
library(survival)
library(tidyr)
```

## The Kaplan-Meier plot and proportional hazards.

A key and very important deviation from proportional hazards is when one group has increased hazard early and a second group has increased hazard late. The Kaplan-Meier curves for the two groups will show this if they cross.

```{r crossing}
n <- 300
t1 <- rexp(n, 1)
t2 <- rexp(n, 2)
t3 <- rexp(n, 0.5)
t4 <- ifelse(t2<0.5, t2, t2+t3)
censor <- as.numeric(c(t1, t4) < 3)
df <- data.frame(
  time=pmin(c(t1, t4), 3), 
  gp=rep(1:2, each=n), 
  censor=censor)
df_surv <- Surv(df$time, df$censor)
plot(survfit(df_surv~df$gp))
```

```{r re-converging}
n <- 300
t1 <- rexp(n, 1)
t2 <- rexp(n, 2)
t3 <- rexp(n, 0.5)
t4 <- rexp(n, 0.5)
t5 <- ifelse(t2<0.5, t2, t2+t3)
t6 <- ifelse(t1<1.2, t1, t1+t4)
censor <- as.numeric(c(t5, t6) < 3)
df <- data.frame(
  time=pmin(c(t5, t6), 3), 
  gp=rep(1:2, each=n), 
  censor=censor)
df_surv <- Surv(df$time, df$censor)
plot(survfit(df_surv~df$gp))
```


## Review the likelihood ratio test

Consider a small data set with the following survival times:

1 M   6 1

2 F  14 1

3 F  44 1

4 M  45 0

5 F  89 0

6 M  98 1

7 F  99 1

8 F 104 1

9 M 114 1

the partial likelihood ratio is

$l_p = \prod_i \frac{\psi_{(i)}}{\sum_{j \in R_{(i)}} \psi_j}$

where the parentheses around the subscript implicitly excludes those patients who were censored,

$\psi_{(i)} = e^{X_{(i)} \beta}$

and $R_{(i)}$ is the set of  all patients at risk at time $t_{(i)}$.

For a simple case with a binary predictor like gender, you would have $\psi_{(i)}$ equalling a constant $\psi$ for females and a constant 1 for males.

It helps to keep tabs on the running number of men and women at risk at each time point.

1 M   6 1 4/5

2 F  14 1 3/5

3 F  44 1 3/4

4 M  45 0 3/3

5 F  89 0 2/3

6 M  98 1 2/2

7 F  99 1 1/2

8 F 104 1 1/1

9 M 114 1 1/0

At t=6, a male died, making the numerator 1. The denominator is 4+5$\psi$ because there are 4 males and 5 females in the risk set. The fraction is

$\frac{1}{4+5\psi}$

At t=14, a female died, making the numerator $\psi$ and the denominator is 3+5$\psi$ because there are 3 males and 5 females in the risk set. The second fraction in the product is

$\frac{\psi}{3+5\psi}$

At t=44, another female died, making the numerator $\psi$ again, but the denominator is 3+4$\psi$ because there are 3 males and 4 females in the risk set. This fraction is

$\frac{\psi}{3+4\psi}$

You skip the censored values of t=45 and t=89. The remaining fractions are

$\frac{1}{2+2\psi}$

$\frac{\psi}{1+2\psi}$

$\frac{\psi}{1+\psi}$

$\frac{1}{1}$

The entire product works out to be

$\frac{\psi^4}{(4+5\psi)(3+5\psi)(3+4\psi)(2+2\psi)(1+2\psi)(1+\psi)}$

Let's plot this for various values of $\psi=e^\beta$.

```{r plot-lr}
lp <- function(beta) {
  psi <- exp(beta)
  f <- psi^4 / 
    ((4+5*psi)*
     (3+5*psi)*
     (3+4*psi)*
     (2+2*psi)*
     (1+2*psi)*
     (1+  psi))
  return(log(f))
}
beta <- seq(-2, 2, length=100)
plot(beta, lp(beta), type="l")
beta[which.max(lp(beta))]
```

The log parial likelihood is

$L_p=\sum_i \big( X_{(i)} \beta - log(\sum_{j \in R_{(i)}} e^{X_j \beta}) \big)$

The derivative of the log partial likelihood is

$\frac{\partial L_p}{\partial \beta}= \sum\limits_{i=1}^m \big( X_{(i)} - \bar{X}_{w{(i)}} \big)$

where $\bar{X}_{w{(i)}}$ is a weighted average of all the X's remaining in the risk set and with weights equal to

$w_{ij}=\frac{e^{X_j \beta}}{\sum_{l \in R_i} e^{X_l \beta}}$.

A positive derivative implies that we could maximize the log partial likelihood by increasing from the current value of $\beta$ and a negative derivative implies the opposite.

The second derivative of the log partial likelihood is

$\frac{\partial L_p}{\partial \beta}= -\sum_i \sum_{j \in R_i}{} w_{ij}\big( X_j - \bar{X}_{w{(i)}} \big)^2$

which is a weighted variance.

The information matrix is the negative of the second derivative and the inverse of the information matrix gives you the variances and covariances of the maximum likelihood estimates.

## Schoenfeld residuals.

The slope of the likelihood function is zero at its maximum, which implies that 

$\sum\limits_{i=1}^m \big( X_{(i)} - \hat{X}_{w{(i)}} \big) = 0$

where $\hat{X}_{w{(i)}$ is equal to $\bar{X}_{w{(i)}$ evaluated at $\beta = \hat{\beta}$


## Time-varying covariates

Page 221 of Hosmer, Lemeshow, and May describes the grace data set, which you can use for time-varying covariates.

```{r read-grace}
fn <- "~/survival-models/data/wiley/GRACE1000.dat" 
grace <- read.table(fn, header = FALSE) 
names(grace) <- c(
  "id",
  "days",
  "death",
  "revasc",
  "revascdays",
  "los",
  "age",
  "sysbp",
  "stchange")
head(grace)
```

## Also for discussion

* Stratified analysis. Stratify whas500 by year=1, 2, 3. This would use the actg320 data. Compare output to Table 7.1.

Save everything for possible later re-use.

```{r save-everything}
save.image("~/survival-models/bin/survival-lecture-7.RData")
```