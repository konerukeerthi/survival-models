---
title: "survival lecture 1"
author: "Steve Simon"
date: "March 24, 2018"
output: html_document
---

This program provides a few supplementary analyses that I need to prepare graphs in the PowerPoint presentation. I am sharing this for those who are curious, but you are not responsible for learning or using the code shown in this supplement.

This file does not need any special libraries other than the ones listed below. Many of the data sets in this program use data from Hosmer, Lemeshow, and May. I made one minor change, however, which was to force all the variable names to lower case.

```{r load-libraries}
library(broom)
library(dplyr)
library(ggplot2)
library(magrittr)
library(survival)
library(tidyr)
```

## Fruit fly data (round 1)

The fly1 data set is intended to illustrate how easy it would be for you to estimate a survival curve if you had no censoring. For a brief overview of this data, refer to data-dictionary-fly1in the doc folder.

To get the program to work properly, you need a variable that equals one for every observation, since every observation represents a time at death rather than a censoring time.

```{r read-fly1}
fn <- "~/survival-models/data/fly1.txt"
fly1 <- read.table(fn, header=FALSE)
names(fly1) <- "time"
print(fly1)
fly1$censor <- 1
fly1_surv <- Surv(fly1$time, fly1$censor)
fly1_km <- survfit(fly1_surv~1)
print(fly1_km)
plot(fly1_km, conf.int=FALSE)
```

## Fruit fly data (round 2)

The fly2 data set illustrates what happens to the data if a scientist accidentally let all the flies still alive at day 70 escape.

```{r read-fly2}
fn <- "~/survival-models/data/fly2.txt"
fly2 <- read.table(fn, header=FALSE)
names(fly2) <- c("time", "censor")
print(fly2)
fly2_surv <- Surv(fly2$time, fly2$censor)
fly2_km <- survfit(fly2_surv~1)
print(fly2_km)
plot(fly2_km, conf.int=FALSE)
```

## Fruit fly data (round 3)

The fly3 data set illustrates what happens to the data if a scientist accidentally let some (but not all) of the flies escape at day 70.

```{r read-fly3}
fn <- "~/survival-models/data/fly3.txt"
fly3 <- read.table(fn, header=FALSE)
names(fly3) <- c("time", "censor")
print(fly3)
fly3_surv <- Surv(fly3$time, fly3$censor)
fly3_km <- survfit(fly3_surv~1)
print(fly3_km)
plot(fly3_km, conf.int=FALSE)
```

## Hand calculation of Kaplan-Meier curve

Table 2.1 of Hosmer, Lemeshow, and May has a very small data set that you can use to calculate the Kaplan-Meier curve by hand. This code shows how R software would generate the graph, just so you can double check your work.

In R, you create a survival object with the Surv function. This object displays itself with every time listed, but with censored times followed with a plus sign. This is fairly standard shorthand.

The survfit function takes a survival object and produces information needed to draw one or more Kaplan-Meier curve. Using ~1 tells R that you want a single curve for all of the data.

```{r read-table21}
fn <- "~/survival-models/data/table21.txt"
table21 <- read.csv(fn, header=TRUE)
print(table21)
table21_surv <- Surv(table21$time, table21$censor)
print(table21_surv)
table21_fit <- survfit(table21_surv~1)
print(table21_fit)
summary(table21_fit)
plot(table21_fit, conf.int=FALSE)
```

## Kaplan-Meier curve using WHAS100 data

Read the data-dictionary-whas100.txt file in the doc subdirectory for information about this data set.

Out of respect for the book's copyright, I am not reproducing the whas100.txt file in the git repository. See README.md in the main folder or the data dictionary file mentioned above for details about how to download this file.

The dotted lines in this graph show how to calculated the confidence limits for one of the quantiles.

```{r plot-with-quartile, fig.width=4.5, fig.height=2}
fn <- "~/survival-models/data/wiley/whas100.dat" 
whas100 <- read.table(fn, header = FALSE) 
names(whas100) <- 
  c("id", "admitdate", "foldate",
    "los", "lenfol", "fstat",
    "age", "gender", "bmi")
whas100$time_yrs <- whas100$lenfol / 365.25
head(whas100)
whas100_surv <- Surv(whas100$time_yrs, whas100$fstat)
whas100_km <- survfit(whas100_surv~1)
par(mar=c(2.1, 2.1, 0.6, 0.6))
q <- quantile(whas100_km)
print(q)
plot(whas100_km, conf.int=TRUE, axes=FALSE)
axis(side=1)
axis(side=2, at=c(0, 0.25, 0.5, 0.75, 1))
segments(q$quantile[1], 0, q$quantile[1], 0.75)
segments(q$lower[1], 0, q$lower[1], 0.75, lty="dotted")
segments(q$upper[1], 0, q$upper[1], 0.75, lty="dotted")
segments(q$upper[1], 0.75, 0, 0.75, lty="dotted")
```

Save everything for possible re-use.

```{r save-everything}
save.image("~/survival-models/bin/survival-lecture-1-supplement.RData")
```