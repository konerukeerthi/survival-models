---
title: "survival lecture 1"
author: "Steve Simon"
date: "March 24, 2018"
output: html_document
---

This file does not need any special libraries other than the ones listed below. Many of the data sets in this program use data from Hosmer, Lemeshow, and May. I made one minor change, however, which was to force all the variable names to lower case.

```{r load-libraries}
library(broom)
library(dplyr)
library(ggplot2)
library(magrittr)
library(survival)
library(tidyr)
```

## Fruit fly data (round 1)

The fly1 data set is intended to illustrate how easy it would be for you to estimate a survival curve if you had no censoring. For a brief overview of this data, refer to data-dictionary-fly1in the doc folder.

To get the program to work properly, you need a variable that equals one for every observation, since every observation represents a time at death rather than a censoring time.

```{r read-fly1}
fn <- "~/survival-models/data/fly1.txt"
fly1 <- read.table(fn, header=FALSE)
names(fly1) <- "time"
print(fly1)
fly1$censor <- 1
fly1_surv <- Surv(fly1$time, fly1$censor)
fly1_km <- survfit(fly1_surv~1)
print(fly1_km)
plot(fly1_km, conf.int=FALSE)
```

## Fruit fly data (round 2)

The fly2 data set illustrates what happens to the data if a scientist accidentally let all the flies still alive at day 70 escape.

```{r read-fly2}
fn <- "~/survival-models/data/fly2.txt"
fly2 <- read.table(fn, header=FALSE)
names(fly2) <- c("time", "censor")
print(fly2)
fly2_surv <- Surv(fly2$time, fly2$censor)
fly2_km <- survfit(fly2_surv~1)
print(fly2_km)
plot(fly2_km, conf.int=FALSE)
```

## Fruit fly data (round 3)

The fly3 data set illustrates what happens to the data if a scientist accidentally let some (but not all) of the flies escape at day 70.

```{r read-fly3}
fn <- "~/survival-models/data/fly3.txt"
fly3 <- read.table(fn, header=FALSE)
names(fly3) <- c("time", "censor")
print(fly3)
fly3_surv <- Surv(fly3$time, fly3$censor)
fly3_km <- survfit(fly3_surv~1)
print(fly3_km)
plot(fly3_km, conf.int=FALSE)
```

## Hand calculation of Kaplan-Meier curve

Table 2.1 of Hosmer, Lemeshow, and May has a very small data set that you can use to calculate the Kaplan-Meier curve by hand. This code shows how R software would generate the graph, just so you can double check your work.

In R, you create a survival object with the Surv function. This object displays itself with every time listed, but with censored times followed with a plus sign. This is fairly standard shorthand.

The survfit function takes a survival object and produces information needed to draw one or more Kaplan-Meier curve. Using ~1 tells R that you want a single curve for all of the data.

```{r read-table21}
fn <- "~/survival-models/data/table21.txt"
table21 <- read.csv(fn, header=TRUE)
print(table21)
table21_surv <- Surv(table21$time, table21$censor)
print(table21_surv)
table21_fit <- survfit(table21_surv~1)
print(table21_fit)
summary(table21_fit)
plot(table21_fit, conf.int=FALSE)
```

## Kaplan-Meier curve using WHAS100 data

Let's look at a larger data set. Read the data-dictionary-whas100.txt file in the doc subdirectory for information about this data set.

Out of respect for the book's copyright, I am not reproducing the whas100.txt file in the git repository. See README.md in the main folder or the data dictionary file mentioned above for details about how to download this file.

```{r read-whas100}
fn <- "~/survival-models/data/wiley/whas100.dat" 
whas100 <- read.table(fn, header = FALSE) 
names(whas100) <- 
  c("id", "admitdate", "foldate",
    "los", "lenfol", "fstat",
    "age", "gender", "bmi")
whas100$time_yrs <- whas100$lenfol / 365.25
head(whas100)
```

Use the same functions, Surv and survfit to create a Kaplan-Meier curve. This plot is the same as Figure 2.2 in Hosmer, Lemeshow, and May.

```{r plot-overall-whas100, fig.width=4.5, fig.height=2}
par(mar=c(2.1, 2.1, 0.6, 0.6))
whas100_surv <- Surv(whas100$time_yrs, whas100$fstat)
whas100_km <- survfit(whas100_surv~1)
plot(whas100_km, conf.int=FALSE)
```

You can easily get confidence intervals (like the ones shown in Figure 2.5 of Hosmer, Lemeshow, and May) and quantile estimates for the Kaplan-Meier curve (like the ones shown in Table 2.5) easily. The mean is not easily computed in R, but there are many reasons why you should not rely on the mean as a summary statistic for survival data. See https://cran.r-project.org/web/packages/survRM2/vignettes/survRM2-vignette3-2.html if you are interested in calculating a mean.

The formula for the estimated variance of a survival curve is

$Var(S(t_i))=S(t_i)^2\sum_{j \leq i}{\frac{d_j}{n_j(n_j-d_j)}}$

```{r plot-with-cis, fig.width=4.5, fig.height=2}
par(mar=c(2.1, 2.1, 0.6, 0.6))
q <- quantile(whas100_km)
print(q)
plot(whas100_km, conf.int=TRUE, axes=FALSE)
axis(side=1)
axis(side=2, at=c(0, 0.25, 0.5, 0.75, 1))
```

The dotted lines in this graph show how to calculated the confidence limits for one of the quantiles.

```{r plot-with-quartile, fig.width=4.5, fig.height=2}
par(mar=c(2.1, 2.1, 0.6, 0.6))
q <- quantile(whas100_km)
print(q)
plot(whas100_km, conf.int=TRUE, axes=FALSE)
axis(side=1)
axis(side=2, at=c(0, 0.25, 0.5, 0.75, 1))
segments(q$quantile[1], 0, q$quantile[1], 0.75)
segments(q$lower[1], 0, q$lower[1], 0.75, lty="dotted")
segments(q$upper[1], 0, q$upper[1], 0.75, lty="dotted")
segments(q$upper[1], 0.75, 0, 0.75, lty="dotted")
```

## Kaplan-Meier curves for two or more groups

You can get Kaplan-Meier curves for two or more groups by changing the ~1 in the survfit function. Here's how you would plot survival curves for males and females for the whas100 data set.

As a general recommendation, try to avoid ploting confidence intervals when you have two or more Kaplan-Meier curves because they become very confusing.

Compare the plot shown below with Figure 2.9 of Hosmer, Lemeshow, and May.

```{r plot-by-gender, fig.width=4.5, fig.height=2}
par(mar=c(2.1, 2.1, 0.6, 0.6))
whas100_km_by_gender <- survfit(whas100_surv~whas100$gender)
plot(whas100_km_by_gender, conf.int=FALSE)
```

There is no legend by default in R. While you can put in a legend, I generally recommend that you place labels directly on the graph instead. It's a bit more work, but it makes the graph look nicer.

```{r plot-with-labels, fig.width=4.5, fig.height=2}
par(mar=c(2.1, 2.1, 0.6, 0.6))
whas100_km_by_gender <- survfit(whas100_surv~whas100$gender)
whas100_km_by_gender %>%
  tidy               %>%
  group_by(strata)   %>%
  slice(n())         -> km_labels
print(km_labels)
plot(whas100_km_by_gender, conf.int=FALSE, xlim=c(0,12))
text(
  km_labels$time, 
  km_labels$estimate, 
  km_labels$strata, adj=0)
```

You should also consider plotting with the ggplot2 library.

```{r plot-with-ggplot2, fig.width=4.5, fig.height=2}
whas100_km_by_gender <- survfit(whas100_surv~whas100$gender)
whas100_km_by_gender %>%
  tidy               %>%
  ggplot(aes(time, estimate, color=strata)) +
    geom_step()
```

## The log rank test

Note: put the data from Table 2.9 in here.

The standard test for comparing two or more Kaplan-Meier curves is the log rank test. You use the survdiff function to get this.

The formulas given in Hosmer, Lemeshow, and May are a bit confusling

$e_{1i}=\frac{n_{1i}d_i}{n_i}$

$v_{1i}=\frac{n_{1i}n_{0i}d_i(n_i-d_i)}{n_i^2(n_i-1)}$

$Q=\frac{(\sum_i{(d_{1i}-e_i)})^2}{\sum_i{V_i}}$

It helps if you compute the estimated probability of death at time i, under the assumption that the two groups are comparable, you get

$p_i=\frac{d_i}{n_i}$

Then $e_{1i}$ becomes the expected number of deaths in the first group at time i, 

$e_{1i}=n_{1i}p_i$

and $v_{1i}$ becomes the estimated binomial variance with a finite population correction factor.

$v_{1i}=n_{1i}p_i(1-p_i)\frac{n_i-n_{1i}}{n_i-1}$

You can also think of this as the variance of a hypergeometric random variable. See https://en.wikipedia.org/wiki/Hypergeometric_distribution.

```{r logrank-test}
survdiff(whas100_surv~whas100$gender)
```

You cannot use a continuous variable like age with the log rank test. When you need to see how a continuous variable affects survival, split the continuous variable into discrete intervals.

```{r age-groups}
age_breaks <- c(0, 59, 69, 79, 99)
age_labels <- c("<60", "60-69", "70-79", ">=80")
whas100$age_group <- cut(whas100$age, age_breaks, age_labels)
table(whas100$age_group, whas100$fstat)
plot(survfit(whas100_surv~whas100$age_group))
survdiff(whas100_surv~whas100$age_group)
```

```{r read-bpd}
fn <- "~/survival-models/data/wiley/bpd.dat" 
bpd <- read.table(fn, header = FALSE) 
names(bpd) <- c("id", "surfact", "ondays", "censor")
head(bpd)
```

Save everything for possible re-use.

```{r save-everything}
save.image("~/survival-models/bin/survival-lecture-1.RData")
```