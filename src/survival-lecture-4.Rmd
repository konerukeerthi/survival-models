---
title: "survival lecture 4"
author: "Steve Simon"
date: "April 8, 2018"
output: html_document
---

Lecture 4. Model fitting and diagnostics for the Cox model. In this lecture, you'll work with more complex forms of the Cox model with multiple predictor variables. You'll include covariates in the Cox model to produce risk adjusted survival curves. You'll also assess the underlying assumptions of the Cox model, particularly the assumption of proportional hazards.

This file does not need any special libraries other than the ones listed below. Many of the data sets in this program use data from Hosmer, Lemeshow, and May. I made one minor change, however, which was to force all the variable names to lower case.

```{r load-libraries}
library(broom)
library(dplyr)
library(ggplot2)
library(magrittr)
library(survival)
library(tidyr)
```

## Cox multivariate regression

Recall that we ran a log rank test for gender using the WHAS100 data file. Let's calculate a Cox regression model for the same data and compare it to the log rank test.

```{r read-whas100}
fn <- "~/survival-models/data/wiley/whas100.dat" 
whas100 <- read.table(fn, header = FALSE) 
names(whas100) <- 
  c("id", "admitdate", "foldate",
    "los", "lenfol", "fstat",
    "age", "gender", "bmi")
whas100$time_yrs <- whas100$lenfol / 365.25
head(whas100)
whas100_surv <- Surv(whas100$time_yrs, whas100$fstat)
```

You should examine your independent variables one at a time before putting them all in a multivariate model.

```{r one-at-a-time}
coxph(Surv(time_yrs, fstat)~los, data=whas100)
coxph(Surv(time_yrs, fstat)~age, data=whas100)
coxph(Surv(time_yrs, fstat)~gender, data=whas100)
coxph(Surv(time_yrs, fstat)~bmi, data=whas100)
```

```{r multivariate-model}
cox_mv <- 
  coxph(Surv(time_yrs, fstat)~los+age+gender+bmi, data=whas100)
summary(cox_mv)
glance(cox_mv)
tidy(cox_mv)
```

Additonal topics to cover.

* GBCS data, hormone, nodes model

* Table 4.13. Gender by age interaction. Predict hazard ratio for gender at age=40, 50, 60, 65, 85, 90. Also see Table 4.14.

* Define risk scores, page 126-130.

* Discuss stepwise selection.

* Fractional polynomials, or maybe smoothing splines.



Save everything for possible later re-use.

```{r save-everything}
save.image("~/survival-models/bin/survival-lecture-4.RData")
```