---
title: "survival lecture 7 lr example"
author: "Steve Simon"
date: "May 20, 2018"
output: html_document
---


## Review the likelihood ratio test

Consider a small data set with the following survival times:

1 M   6 1

2 F  14 1

3 F  44 1

4 M  45 0

5 F  89 0

6 M  98 1

7 F  99 1

8 F 104 1

9 M 114 1

the partial likelihood ratio is

$l_p = \prod_i \frac{\psi_{(i)}}{\sum_{j \in R_{(i)}} \psi_j}$

where the parentheses around the subscript implicitly excludes those patients who were censored,

$\psi_{(i)} = e^{X_{(i)} \beta}$

and $R_{(i)}$ is the set of  all patients at risk at time $t_{(i)}$.

For a simple case with a binary predictor like gender, you would have $\psi_{(i)}$ equalling a constant $\psi$ for females and a constant 1 for males.

It helps to keep tabs on the running number of men and women at risk at each time point.

1 M   6 1 4/5

2 F  14 1 3/5

3 F  44 1 3/4

4 M  45 0 3/3

5 F  89 0 2/3

6 M  98 1 2/2

7 F  99 1 1/2

8 F 104 1 1/1

9 M 114 1 1/0

At t=6, a male died, making the numerator 1. The denominator is 4+5$\psi$ because there are 4 males and 5 females in the risk set. The fraction is

$\frac{1}{4+5\psi}$

At t=14, a female died, making the numerator $\psi$ and the denominator is 3+5$\psi$ because there are 3 males and 5 females in the risk set. The second fraction in the product is

$\frac{\psi}{3+5\psi}$

At t=44, another female died, making the numerator $\psi$ again, but the denominator is 3+4$\psi$ because there are 3 males and 4 females in the risk set. This fraction is

$\frac{\psi}{3+4\psi}$

You skip the censored values of t=45 and t=89. The remaining fractions are

$\frac{1}{2+2\psi}$

$\frac{\psi}{1+2\psi}$

$\frac{\psi}{1+\psi}$

$\frac{1}{1}$

The entire product works out to be

$\frac{\psi^4}{(4+5\psi)(3+5\psi)(3+4\psi)(2+2\psi)(1+2\psi)(1+\psi)}$

Let's plot this for various values of $\psi=e^\beta$.

```{r plot-lr}
lp <- function(beta) {
  psi <- exp(beta)
  f <- psi^4 / 
    ((4+5*psi)*
     (3+5*psi)*
     (3+4*psi)*
     (2+2*psi)*
     (1+2*psi)*
     (1+  psi))
  return(log(f))
}
beta <- seq(-2, 2, length=100)
plot(beta, lp(beta), type="l")
beta[which.max(lp(beta))]
```

The second derivative of the log partial likelihood is

$\frac{\partial L_p}{\partial \beta}= -\sum_i \sum_{j \in R_i}{} w_{ij}\big( X_j - \bar{X}_{w{(i)}} \big)^2$

which is a weighted variance.

The information matrix is the negative of the second derivative and the inverse of the information matrix gives you the variances and covariances of the maximum likelihood estimates.



Save everything for possible later re-use.

```{r save-everything}
save.image("~/survival-models/bin/survival-lecture-7-lr-example.RData")
```